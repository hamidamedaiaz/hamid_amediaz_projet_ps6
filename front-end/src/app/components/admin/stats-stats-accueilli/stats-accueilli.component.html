<div class="stats-container">
  <div class="stats-content">
    <h2>Statistiques des Accueillis</h2>
    
    <div class="stats-header">
      <div class="stats-search">
        <input
          type="text"
          placeholder="Rechercher un accueilli..."
          [(ngModel)]="searchQuery"
          class="search-input"
        />
      </div>
      <div class="stats-filters">
        <select [(ngModel)]="sortBy" class="filter-select">
          <option value="name">Trier par nom</option>
          <option value="count">Trier par quiz joués</option>
          <option value="score">Trier par score moyen</option>
        </select>
      </div>
    </div>
    
    <table class="stats-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Quiz Joués</th>
          <th>Score Moyen</th>
          <th>Dernier Quiz</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let profile of filteredProfiles()" [class.highlighted]="selectedProfile?.id === profile.id">
          <td>{{ profile.id }}</td>
          <td>{{ profile.lastName }}</td>
          <td>{{ profile.name }}</td>
          <td>{{ getQuizCountForProfile(profile) }}</td>
          <td>{{ getAverageScore(profile) }}%</td>
          <td>{{ getLastPlayedDate(profile) }}</td>
          <td>
            <button class="action-btn" (click)="viewProfileDetails(profile)">
              Détails
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination">
      <button 
        [disabled]="currentPage === 1" 
        (click)="changePage(currentPage - 1)"
        class="page-btn"
      >
        &laquo;
      </button>
      <span class="page-info">{{ currentPage }} / {{ getTotalPages() }}</span>
      <button 
        [disabled]="currentPage === getTotalPages()" 
        (click)="changePage(currentPage + 1)"
        class="page-btn"
      >
        &raquo;
      </button>
    </div>
  </div>

  <!-- Modal de détails du profil -->
  <div *ngIf="selectedProfile" class="modal profile-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Profil de l'Accueilli</h2>
        <span class="close-btn" (click)="closeProfileDetails()">&times;</span>
      </div>
      
      <div class="profile-details">
        <div class="profile-card">
          <div class="profile-avatar">
            {{ getInitials(selectedProfile) }}
          </div>
          <div class="profile-info">
            <h3 class="profile-name">{{ selectedProfile.name }} {{ selectedProfile.lastName }}</h3>
            <p class="profile-id">ID: {{ selectedProfile.id }}</p>
          </div>
        </div>
        
        <div class="stats-overview">
          <div class="stat-item">
            <span class="stat-value">{{ getQuizCountForProfile(selectedProfile) }}</span>
            <span class="stat-label">Quiz Joués</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getAverageScore(selectedProfile) }}%</span>
            <span class="stat-label">Score Moyen</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getAverageResponseTime(selectedProfile) }}s</span>
            <span class="stat-label">Temps de réponse moyen</span>
          </div>
        </div>
        
        <div class="therapy-stats">
          <h3>Métriques thérapeutiques</h3>
          <div class="stats-grid">
            <div class="therapy-stat-item">
              <div class="stat-icon hints-icon">
                <i class="fa fa-lightbulb-o"></i>
              </div>
              <div class="stat-details">
                <span class="stat-value">{{ getAverageHintsUsed(selectedProfile) }}</span>
                <span class="stat-label">Moyenne d'indices utilisés</span>
                <div class="stat-trend positive">
                  <span>-0.5 par rapport au mois dernier</span>
                </div>
              </div>
            </div>
            
            <div class="therapy-stat-item">
              <div class="stat-icon time-icon">
                <i class="fa fa-clock-o"></i>
              </div>
              <div class="stat-details">
                <span class="stat-value">{{ getAverageResponseTime(selectedProfile) }}s</span>
                <span class="stat-label">Temps moyen entre réponses</span>
                <div class="stat-trend negative">
                  <span>+2.3s par rapport au mois dernier</span>
                </div>
              </div>
            </div>
            
            <div class="therapy-stat-item">
              <div class="stat-icon correct-icon">
                <i class="fa fa-check"></i>
              </div>
              <div class="stat-details">
                <span class="stat-value">{{ getCorrectAnswersPercentage(selectedProfile) }}%</span>
                <span class="stat-label">Réponses correctes</span>
                <div class="stat-trend positive">
                  <span>+5% par rapport au mois dernier</span>
                </div>
              </div>
            </div>
            
            <div class="therapy-stat-item">
              <div class="stat-icon incorrect-icon">
                <i class="fa fa-times"></i>
              </div>
              <div class="stat-details">
                <span class="stat-value">{{ getIncorrectAnswersPercentage(selectedProfile) }}%</span>
                <span class="stat-label">Réponses incorrectes</span>
                <div class="stat-trend positive">
                  <span>-5% par rapport au mois dernier</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <h3>Historique des Parties</h3>
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Quiz</th>
              <th>Score</th>
              <th>Indices utilisés</th>
              <th>Temps moyen/question</th>
              <th>Bonnes réponses</th>
              <th>Mauvaises réponses</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let game of getProfileGameHistory(selectedProfile)">
              <td>{{ game.date }}</td>
              <td>{{ game.quizTitle }}</td>
              <td>{{ game.score }}%</td>
              <td>{{ game.hintsUsed }} / {{ game.totalHints }}</td>
              <td>{{ game.avgResponseTime }}s</td>
              <td>{{ game.correctAnswers }} / {{ game.totalQuestions }}</td>
              <td>{{ game.incorrectAnswers }}</td>
              <td>
                <button class="details-btn" (click)="viewGameDetails(game)">
                  Détails
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        
        <h3>Progression</h3>
        <div class="metrics-tabs">
          <button class="tab-btn" [class.active]="activeTab === 'score'" (click)="setActiveTab('score')">Score global</button>
          <button class="tab-btn" [class.active]="activeTab === 'hints'" (click)="setActiveTab('hints')">Utilisation des indices</button>
          <button class="tab-btn" [class.active]="activeTab === 'time'" (click)="setActiveTab('time')">Temps de réponse</button>
          <button class="tab-btn" [class.active]="activeTab === 'accuracy'" (click)="setActiveTab('accuracy')">Précision</button>
        </div>
        
        <div class="progress-chart" *ngIf="activeTab === 'score'">
          <div *ngFor="let month of getProfileProgress(selectedProfile, 'score'); let i = index" 
               class="progress-bar" 
               [style.height.%]="month.value">
            <span class="progress-label">{{ month.value }}%</span>
            <span class="month-label">{{ month.month }}</span>
          </div>
        </div>
        
        <div class="progress-chart" *ngIf="activeTab === 'hints'">
          <div *ngFor="let month of getProfileProgress(selectedProfile, 'hints'); let i = index" 
               class="progress-bar hints-bar" 
               [style.height.%]="getPercentageValue(month.value, 5)">
            <span class="progress-label">{{ month.value }}</span>
            <span class="month-label">{{ month.month }}</span>
          </div>
        </div>
        
        <div class="progress-chart" *ngIf="activeTab === 'time'">
          <div *ngFor="let month of getProfileProgress(selectedProfile, 'time'); let i = index" 
               class="progress-bar time-bar" 
               [style.height.%]="getPercentageValue(month.value, 30)">
            <span class="progress-label">{{ month.value }}s</span>
            <span class="month-label">{{ month.month }}</span>
          </div>
        </div>
        
        <div class="progress-chart" *ngIf="activeTab === 'accuracy'">
          <div *ngFor="let month of getProfileProgress(selectedProfile, 'accuracy'); let i = index" 
               class="progress-bar accuracy-bar" 
               [style.height.%]="month.value">
            <span class="progress-label">{{ month.value }}%</span>
            <span class="month-label">{{ month.month }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal de détails de la session de jeu -->
  <div *ngIf="selectedGame" class="modal game-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Détails de la session</h2>
        <span class="close-btn" (click)="closeGameDetails()">&times;</span>
      </div>
      
      <div class="game-details">
        <div class="session-info">
          <div class="session-header">
            <h3>{{ selectedGame.quizTitle }}</h3>
            <span class="session-date">{{ selectedGame.date }}</span>
          </div>
          
          <div class="session-stats">
            <div class="session-stat">
              <span class="stat-label">Score total</span>
              <span class="stat-value">{{ selectedGame.score }}%</span>
            </div>
            <div class="session-stat">
              <span class="stat-label">Temps total</span>
              <span class="stat-value">{{ selectedGame.time }}</span>
            </div>
            <div class="session-stat">
              <span class="stat-label">Indices utilisés</span>
              <span class="stat-value">{{ selectedGame.hintsUsed }} / {{ selectedGame.totalHints }}</span>
            </div>
          </div>
        </div>
        
        <h3>Détails par question</h3>
        <div class="question-details-list">
          <div *ngFor="let question of selectedGame.questions; let i = index" class="question-detail-item">
            <div class="question-header">
              <div class="question-number">Question {{ i + 1 }}</div>
              <div class="question-result" [ngClass]="question.isCorrect ? 'correct' : 'incorrect'">
                {{ question.isCorrect ? 'Réponse correcte' : 'Réponse incorrecte' }}
              </div>
            </div>
            
            <div class="question-content">
              <p class="question-text">{{ question.text }}</p>
              
              <div class="question-metrics">
                <div class="metric">
                  <span class="metric-label">Temps de réponse:</span>
                  <span class="metric-value">{{ question.responseTime }}s</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Indices utilisés:</span>
                  <span class="metric-value">{{ question.hintsUsed }} / {{ question.availableHints }}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Tentatives:</span>
                  <span class="metric-value">{{ question.attempts }}</span>
                </div>
              </div>
              
              <div class="answer-section">
                <div class="selected-answer" [ngClass]="{'correct-answer': question.isCorrect, 'incorrect-answer': !question.isCorrect}">
                  <strong>Réponse sélectionnée:</strong> {{ question.selectedAnswer }}
                </div>
                <div *ngIf="!question.isCorrect" class="correct-answer">
                  <strong>Réponse correcte:</strong> {{ question.correctAnswer }}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="recommendations">
          <h3>Recommandations</h3>
          <ul class="recommendation-list">
            <li *ngFor="let rec of getRecommendations(selectedGame)" class="recommendation-item">
              {{ rec }}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>